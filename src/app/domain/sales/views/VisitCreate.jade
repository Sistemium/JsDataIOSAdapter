h3.pull-right.with-map
  button.btn.ml-em.btn-default(ng-click='vm.takePhoto()' ng-disabled='!vm.visit.checkInLocationId')
    i.glyphicon.glyphicon-camera
  = ' '
  button.btn.btn-default.ml-5(
  ng-disabled='!vm.visit.checkInLocation'
  popover-placement="bottom-left auto"
  popover-trigger='outsideClick'
  uib-popover-template="'app/domain/sales/views/location.html'"
  popover-is-open='vm.visitMapPopoverOpen'
  type='button'
  ng-class='{green: vm.visit.checkInLocation, gray: !vm.visit.checkInLocation, "blink-color": vm.locating}'
  )
    i.glyphicon.glyphicon-map-marker

h3.clear-left.pull-left

  span.text-danger(ng-if='vm.creatingMode') Новый визит
  span.gray(ng-if='!vm.creatingMode') {{ vm.visit.deviceCts | amUtc | amLocal | amCalendar }}
  small
    a.ml-5(href ng-click='vm.deleteVisit()' ng-if='!vm.creatingMode')
      i.glyphicon.glyphicon-trash

h3.pull-right.clear-right
  button.btn.ml-10(
  type='button'
  ng-class='b.class || "btn-default"'
  ng-disabled='b.isDisabled()'
  ng-repeat='b in vm.buttons track by b.label'
  ng-click='vm[b.clickFn]()'
  )
    i(ng-class='b.fa')
    span {{ b.label }}


hr.clear-both

section.fow-fluid.mt(ng-if='vm.visit.photos.length')
  .col-xs-3.col-sm-2(ng-repeat='pic in vm.visit.photos track by pic.id')
    a.thumbnail.mh-80(href ng-click='vm.thumbnailClick(pic)')
      img(ng-src='{{vm.thumbnails[pic.id]}}')

section.clear-both(cg-busy='{promise: vm.busy, message: vm.busyMessage || "Загрузка данных…"}' ng-class='{mt: !vm.visit.photos.length}')

  uib-tabset.nav-tabs-right(active="active")
    uib-tab(
    index="$index + 1"
    ng-repeat="qs in vm.questionSets | orderBy:['ord','name'] track by qs.id"
    heading="{{qs.name}}"
    disable="qs.isInvalid"
    )
      section(ng-repeat='grp in qs.questionGroups | orderBy:"name" track by grp.id' ng-if='vm.answers')
        h3
          .lead {{ grp.name }}
        .form.form-horizontal
          .form-group.row-fluid(ng-repeat='qst in grp.questions | orderBy:"name" track by qst.id')
            label.control-label.col-xs-6.col-sm-9.col-md-10 {{ qst.name }}
            .col-xs-6.col-sm-3.col-md-2(ng-switch="qst.dataType.code")
              sa-number-spinner(
              ng-switch-when="number"
              initval='{{vm.answers[qst.id]}}'
              ng-model='vm.answers[qst.id]'
              ng-change='vm.changeAnswer(qst,vm.answers[qst.id])'
              )
              toggle-switch.w100(
              ng-switch-when="boolean"
              ng-model="vm.answers[qst.id]"
              ng-change='vm.changeAnswer(qst,vm.answers[qst.id])'
              on-label="Да"
              off-label="Нет"
              )
              input.form-control.clickable(
              ng-switch-when='date'
              type='text'
              uib-datepicker-popup=''
              ng-model="vm.answers[qst.id]"
              ng-change='vm.changeAnswer(qst,vm.answers[qst.id])'
              is-open='vm.isDatepickerOpen'
              ng-click='vm.isDatepickerOpen=true'
              ng-required='true'
              autocomplete='off'
              show-button-bar='false'
              readonly=''
              )
              input.form-control(
              ng-switch-default type="text"
              ng-model="vm.answers[qst.id]"
              ng-change='vm.changeAnswer(qst,vm.answers[qst.id])'
              )
